# Environment variables
REGION=us-east1
PROJECT=kolban-product-search
API-KEY=2adbf59c-61fd-46f6-a2c7-2ac924dae30c
SERVICE-ACCOUNT=demo-sa@kolban-product-search.iam.gserviceaccount.com
GCS-PREFIX=gs://kolban-fashion-products/fashion-dataset
PRODUCT_SEARCH_PRODUCT_SET=my_product_set

all:
	@echo "Configuration"
	@echo "-------------"
	@echo "create-product-search     - Create the Product Search definition."
	@echo "describe-product-search   - Examine the Product Search definition."
	@echo "delete-product-search     - Delete the Product Search definitions."
	@echo "upload-csv                - Upload the CSVs used for Product Search."




# Create the product search information from the CSV data describing the product-set/products/images.
create-product-search:
	gcloud beta ml vision product-search product-sets import $(GCS-PREFIX)/0_9999.csv --location $(REGION) --project $(PROJECT) > /tmp/product_search.log
	gcloud beta ml vision product-search product-sets import $(GCS-PREFIX)/10000_19999.csv --location $(REGION) --project $(PROJECT) >> /tmp/product_search.log
	gcloud beta ml vision product-search product-sets import $(GCS-PREFIX)/20000_29999.csv --location $(REGION) --project $(PROJECT) >> /tmp/product_search.log
	gcloud beta ml vision product-search product-sets import $(GCS-PREFIX)/30000_39999.csv --location $(REGION) --project $(PROJECT) >> /tmp/product_search.log
	gcloud beta ml vision product-search product-sets import $(GCS-PREFIX)/40000_44424.csv --location $(REGION) --project $(PROJECT) >> /tmp/product_search.log


# Display the details of the product search entry for the product set called "my_product_set".  Watch for index time being recent.
describe-product-search:
	gcloud beta ml vision product-search product-sets describe $(PRODUCT_SEARCH_PRODUCT_SET) --location $(REGION) --project $(PROJECT)
	gcloud beta ml vision product-search products list --location=$(REGION) --project $(PROJECT)


# Delete the definitions for product search.  This includes products and product-sets.
delete-product-search:
	gcloud beta ml vision product-search product-sets delete $(PRODUCT_SEARCH_PRODUCT_SET) --location=$(REGION) --quiet --project $(PROJECT)
	gcloud beta ml vision product-search product-sets list --location=$(REGION) --project $(PROJECT)
	gcloud alpha ml vision product-search products delete-all $(REGION) --product-set $(PRODUCT_SEARCH_PRODUCT_SET) --force --project $(PROJECT)
	gcloud alpha ml vision product-search products delete-all $(REGION) --orphan-products --force --project $(PROJECT)
	gcloud beta ml vision product-search products list --location=$(REGION) --project $(PROJECT)


# Upload the CSVs used for Product Search into GCS.  These CSV files are generated by the IPython notebook that processes the dataset
# file called styles.csv.  The CSVs are in the format required for Product Search definitions and constrained to be 10,000 entries or less.
upload-csv:
	gsutil cp 0_9999.csv $(GCS-PREFIX)
	gsutil cp 10000_19999.csv $(GCS-PREFIX)
	gsutil cp 10000_19999.csv $(GCS-PREFIX)
	gsutil cp 20000_29999.csv $(GCS-PREFIX)
	gsutil cp 30000_39999.csv $(GCS-PREFIX)
	gsutil cp 40000_44424.csv $(GCS-PREFIX)

